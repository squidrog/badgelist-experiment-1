<!DOCTYPE html>
<html>

	<head>
		<title>badgelist-experiment-1</title>

		<link href="style.css" rel="stylesheet" type="text/css">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	</head>

	<body>
	
		<div id="instructions">
			<h3>Instructions:</h3>
			<p>Use the small textbox to search for pending feedback requests from the input group</p>
		</div>

		<!--the box for the user to paste the url of the group-->
		<div id="inputField">
			<label for="groupUrl">Group URL</label>
			<input type="text" id="groupUrl" value="community">
			<p class="infoText">
				Enter the the unique part of the group's url.
			</p>
		</div>

		<!--button calls javascript function-->
		<div id="center">
			<button onclick="getPendingFeedback()">Get Pending Feedback Requests</button>
		</div>

		<!--output textarea for links to all feedback requests-->
		<div id=output>
			<textarea id="outputArea" rows="10" cols="70" class="textAreaFormat"></textarea>
		</div>

			
	</body>

	<script type="text/javascript">

		var group = {};
		var badges = {}; // fullBadgeUrl => badgeObject
		var logs = {}; // fullBadgeUrl => userId => logObject
		var pendingRequests = 0;
		var allRequestsSent = false;
		
		function getPendingFeedback() {
			var listOfBadges = [];
			var finalOutputString = "";
			var groupUrl = document.getElementById("groupUrl").value;

			if (groupUrl.indexOf('/') == -1) groupUrl = 'https://www.badgelist.com/' + groupUrl;

			//chrome does not allow xmlhttprequest to a different domain than the page is on so this will not work in chrome
			//retrieves and saves the list of badges in the group
			$.getJSON(groupUrl + ".json", function(groupResponse) {
				group = groupResponse;
				console.log(groupResponse);

				for (var i = 0; i < group.badges.length; i++) {
					//retrieves and saves the ids of learners of the current badge
					$.getJSON(groupUrl + "/" + group.badges[i] + ".json" , function(badgeResponse) {
						badges[badgeResponse.full_url.toLowerCase() + '.json'] = badgeResponse;
						logs[badgeResponse.full_url.toLowerCase() + '.json'] = {};

						for (var j = 0; j < badgeResponse.learners.length; j++){
							pendingRequests++;
							
							$.getJSON(badgeResponse.full_url + "/u/" + badgeResponse.learners[j] + ".json" , function(logResponse) {
								var urlParts = logResponse.evidence.split('/');
								logs[logResponse.badge][urlParts[urlParts.length - 1]] = logResponse;
								
								pendingRequests--;

								if (allRequestsSent && (pendingRequests == 0)){
									console.log('Done!');
									$.each(logs, function(badgeUrl, userNames){
										$.each(userNames, function(users, userProfile){
											console.log(userProfile);
											if (userProfile.validation_status == 'requested'){
												finalOutputString = finalOutputString + userProfile.evidence + "\n";
											}
										})
									})
									document.getElementById("outputArea").value = finalOutputString;
								}
									
							});
						}
					});
				}

				allRequestsSent = true;
			});
			
		}


	</script>
</html>